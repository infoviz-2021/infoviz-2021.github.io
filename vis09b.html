<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="data/keys2.js"></script>
    <link rel="stylesheet" href="vis06-08-styles.css">
    <title>Trabalho de InfoViz - Vis09</title>

  </head>
  <body>
    <h2 class="text-title">Challenge types of HInt presented by the analyzed publications</h2>
    
    <!-- Add 3 radios -->
      <div class="text-legend">
        <strong>Order publication by:</strong>
        <input type="radio" id="citation"
          name="order" value="citation" onclick="update('citation')">
        <label for="citation" onclick="update('citation')">Citation</label>
    
        <input type="radio" id="focus"
          name="order" value="focus" onclick="update('focus')">
        <label for="focus" onclick="update('focus')">Focus</label>

        <input type="radio" id="year"
        name="order" value="year" onclick="update('year')" checked="checked">
        <label for="year" onclick="update('year')">Year</label>

      </div>
   

    <!-- Create a div where the graph will take place -->
    <div id="focus_legend"></div>
    <div id="my_dataviz"></div>
    <div class='tooltip'></div>
    <div class='labelX'></div>
    <div>

      <!--svg width='100%' height='100%' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'>

        <title>SVG Table</title>
     
        <g id='columnGroup'>
           <rect x='65' y='10' width='75' height='110' fill='gainsboro'/>
           <rect x='265' y='10' width='75' height='110' fill='gainsboro'/>
     
           <text x='30' y='30' font-size='18px' font-weight='bold' fill='crimson'>
              <tspan x='30' dy='1.5em'>Q1</tspan>
              <tspan x='30' dy='1em'>Q2</tspan>
              <tspan x='30' dy='1em'>Q3</tspan>
              <tspan x='30' dy='1em'>Q4</tspan>
           </text>
     
           <text x='100' y='30' font-size='18px' text-anchor='middle'>
              <tspan x='100' font-weight='bold' fill='crimson'>Sales</tspan>
              <tspan x='100' dy='1.5em'>$ 223</tspan>
              <tspan x='100' dy='1em'>$ 183</tspan>
              <tspan x='100' dy='1em'>$ 277</tspan>
              <tspan x='100' dy='1em'>$ 402</tspan>
           </text>
     
           <text x='200' y='30' font-size='18px' text-anchor='middle'>
              <tspan x='200' font-weight='bold' fill='crimson'>Expenses</tspan>
              <tspan x='200' dy='1.5em'>$ 195</tspan>
              <tspan x='200' dy='1em'>$ 70</tspan>
              <tspan x='200' dy='1em'>$ 88</tspan>
              <tspan x='200' dy='1em'>$ 133</tspan>
           </text>
     
           <text x='300' y='30' font-size='18px' text-anchor='middle'>
              <tspan x='300' font-weight='bold' fill='crimson'>Net</tspan>
              <tspan x='300' dy='1.5em'>$ 28</tspan>
              <tspan x='300' dy='1em'>$ 113</tspan>
              <tspan x='300' dy='1em'>$ 189</tspan>
              <tspan x='300' dy='1em'>$ 269</tspan>
           </text>
        </g>
     </svg-->
    </div>

    <script>

      // set the dimensions and margins of the graph
      var margin = {top: 20, right: 50, bottom: 320, left: 280},
              width = 1100 - margin.left - margin.right,
              height = 480 - margin.top - margin.bottom;

      // Initialize plot
      update('year');

      function update(orderBy){
      
        d3.select("#my_dataviz").remove();
        d3.selectAll("#focus_legend").remove();
        d3.selectAll(".label-axisX").remove();

        
        //legend: append the svg object to the body of the page
        var svg_legend = d3.select("body")
          .append("div")
          .attr("id", "focus_legend")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", 70)
          .append("g")
          .attr("transform",
                  "translate(" + 10 + "," + 10 + ")");

        //graph: append the svg object to the body of the page
        var svg = d3.select("body")
            .append("div")
            .attr("id","my_dataviz")
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform",
                    "translate(" + margin.left + "," + margin.top + ")");
              
        // Initialize the X axis
        var x = d3.scaleBand()
          .range([0, width ])
         // .padding(0.2);

        var xAxis = svg.append("g")
          .attr("class", "myXaxis text-axis")
          .attr("transform", "translate(0," + height + ")")

        // Initialize the Y axis
        var y = d3.scaleBand()
          .range([height, 0])
         // .padding(0.6);

        var yAxis = svg.append("g")
          .attr("class", "myYaxis text-axis")
        
         // Color scale: give me a focus, I return a color
        var color = d3.scaleOrdinal()
            .domain(keys.map(d => d.key))
            .range(d3.schemeSet2);
        
        var focus = d3.scaleOrdinal()
          .domain(keys.map( d => d.key))
          .range(keys.map(d=> d.order))
      
        var challengeMap = d3.scaleOrdinal()
          .domain(impacts.map( d => d.key))
          .range(impacts.map(d=> d.name))

        //Read the data
        var url = "data/data_vis09.json";
        
        d3.json(url).then(function (file) {
          
          //get data relation citation x contribution
          data = file.data
          //get papers info
          papers = file.papers

          //sort data by year
          var sortedData = data.slice().sort((a, b) => d3.ascending(a.year, b.year) || d3.descending(a.citation, b.citation))
          var mouseYSpace = 80
          var limitHeight = 50
    
          //sort data by citation
          if(orderBy === 'citation'){
            sortedData = data.slice().sort((a, b) => d3.ascending(a.citation, b.citation) || d3.ascending(a.year, b.year))
            mouseYSpace = 150
            limitHeight = 60
          }else if(orderBy === 'focus'){
             //sort data by focus
            sortedData = data.slice().sort((a, b) => d3.ascending(focus(a.focus), focus(b.focus)))
            mouseYSpace = 90
            limitHeight = 50
          }

          // Add X axis
        //  x.domain(impacts.map(d => d.key));
         // xAxis.call(d3.axisBottom(x).tickSize(0));

         radius = 10
         shiftAxis = {x:radius*1.5, y:radius*1.2}

         var className = function (d){ 
            var s = d.split(' ')
              newClass = ""
              s.forEach( e => newClass += e)
              s = newClass.replace('.','').replace(',','');
            return s
         }

         // Add X axis
          x.domain(sortedData.map(d => d.citation));
          xAxis.call(d3.axisBottom(x).tickSize(0))
            .selectAll("text")
            //.attr("y", 0)
           // .attr("x", 10)
            .attr("class", d => {return className(d)})
            .attr("dy", ".50em")
            .attr("dx", "-.50em")
            .attr("transform", "rotate(-35)")
            .style("text-anchor", "end")
            .attr("cursor","default")
            .on("mouseover", highlight)
            .on("mouseleave", noHighlight);

          //Add contribution description on X axis
        /*  contributions.forEach(c => {
            d3.select("body")
            .append("div")
              .attr("class","label-axisX text-axis")
              .style("left", x(c.key) + margin.left -5+ "px"  )
              .style("top", height + 195 + "px") // 100 is where the first dot appears. 25 is the distance between dots
              .style("text-align", "center")
              .html(c.name)
              .style("text-anchor", "center")
              .style('position','absolute')
              .style("max-width", (width/4)-10 + "px")
          })
*/
          // Add X axis title
          svg.append("text")
              .attr("text-anchor", "end")
              .attr("x", width/2-80)
              .attr("y", height+150)
              .attr("text-anchor", "left")
              .text("Publication");


          sortedChallenge = impacts.slice().sort((a,b) => d3.ascending(a.order, b.order))
          // Add Y axis
          y.domain(sortedChallenge.map(d => d.key));
          yAxis.call(d3.axisLeft(y).tickSize(0))
          .selectAll("text")
            .attr("class",d => { return "axisY-" + d})
            //.text(d => { return challengeMap(d) + `(${d}) `})
            .text(d => { return challengeMap(d)})
            .attr("dx", "-0.2em")
            .attr("cursor","default")
            .on("mouseover", function(e,d){
          
              d3.select(".axisY-" + d)
                .attr("font-weight", "bold")

              d3.selectAll("." +  d)
                .style("fill", function(d) { return d3.rgb(color(d.focus)).darker(0.5)} )
                        
              //Get Contribution description
              const foundImpact = impacts.find(element => element.key == d);

              console.log(foundImpact)

              d3.select('.tooltip')
                .style('visibility','visible')
                .style('top', e.pageY + 10  + 'px' )
                .style('left', e.pageX + 5 + 'px')
                .style('max-width',500)
                //.style('left',function(){ return ( e.pageX < (width) ?  e.pageX + 10 : e.pageX - 300 ) + 'px'})
               // .html('<strong>Challenge type: </strong>'+  foundImpact.name + " (" + foundImpact.key + ")"+
               //       '</br><strong>Description: </strong>' + foundImpact.description)
                .html('<strong>Description: </strong>' + foundImpact.description)
          
            })
            .on("mouseleave", function(e,d){
          
              d3.select(".axisY-" + d).attr("font-weight", "normal")
              d3.selectAll("." +  d)
              .style("fill", function(d) { return color(d.focus)} )
          

              d3.select('.tooltip')
                .style('visibility','hidden')
            })

          // Y axis title:
          svg.append("text")
              .attr("text-anchor", "end")
              .attr("transform", "rotate(-90)")
              .attr("y", -margin.left+20)
              .attr("x", -height/2+50)
              .text("Challenge type")


          // variable u: map data to existing rect
          var u = svg.selectAll("circle")
            .data(sortedData, function(d) {return d.impact + ':' + d.citation;})

          u.enter()
          .append("circle")
          .merge(u)
          .attr("class", function(d) { return "myArea " + d.focus + " circle-" +  className(d.citation) + " " + d.impact})
          .attr("cx", function(d) { return x(d.citation) + shiftAxis.x})
          .attr("cy", function(d) { return y(d.impact) + shiftAxis.y })
          //.attr("width", x.bandwidth() )
          //.attr("height", y.bandwidth() )
          .attr("r", radius)
          //.attr("ry", 4)
          .style("fill", function(d) {return color(d.focus)})
          .on("mouseover", function(e,d) {  

            //change rect color
            d3.select(this)
              .style("fill", function(d) { return d3.rgb(color(d.focus)).darker(0.5)} )
              .transition()     // adds animation
              .duration(100)
              .attr("y", function(d) { return y(d.citation) - 3})
              .attr("height", y.bandwidth() + 6)
              
              //Get Focus and Contribution description
              const foundImpact = impacts.find(element => element.key == d.impact);
              const foundFocus = keys.find(element => element.key == d.focus);
              const foundPaper= papers.find(element => element.id === d.id);

              authors =  "<strong>Authors: </strong>"

              if(foundPaper.qt_author === 1){
                authors = "<strong>Author: </strong>" 
              }

              authors += foundPaper.citation_order

              d3.select('.tooltip')
                .style('visibility','visible')
                .style('top', function(){ return ( e.pageY < (height + limitHeight) ?  e.pageY + 10 : e.pageY - mouseYSpace ) + 'px'} )
                .style('left', e.pageX + 10 + 'px')
                //.style('left',function(){ return ( e.pageX < (width) ?  e.pageX + 10 : e.pageX - 300 ) + 'px'})
                .html('<strong>Publication title: </strong>'+ foundPaper.title + 
                      '</br><strong>Focus: </strong> HInt ' + foundFocus.name + " (" + foundFocus.key + ")"+
                      '</br><strong>Challenge: </strong>' + foundImpact.name + " (" + foundImpact.key + ")"+
                      '</br><strong>Event/Forum: </strong>' + foundPaper.event +
                      '</br>' + authors)
            })
            .on("mouseleave", function (e, d){  

                d3.select('.tooltip')
                  .style('visibility','hidden')

                d3.select(this)
                  .style("stroke", "none")
                  .style("fill", function(d) { return color(d.focus)} )
                  .transition()     // adds animation
                  .duration(100)
                    .attr("height", y.bandwidth())
                    .attr("y", function(d) { return y(d.citation) })
            })

        })
        .catch(err => console.log(err)); //end d3.json reading

        /****************************************** HIGHLIGHT ***************************************/

        var className = function (d){ 
            var s = d.split(' ')
              newClass = ""
              s.forEach( e => newClass += e)
              s = newClass.replace('.','').replace(',','');
            return s
         }


        // What to do when one group is hovered
        var highlight = function(e,d){     

          if(typeof d == 'string'){

              d3.select("." + className(d)).attr("font-weight", "bold")
              d3.selectAll(".circle-" +  className(d))
                .style("fill", function(d) { return d3.rgb(color(d.focus)).darker(0.5)} )
      
          }else{
            //set font label to bold
            d3.selectAll(".label-"+d.key)
            .attr("font-weight", "bold")

            d3.select(".mycircle-legend"+d.key)
            .style("fill", function(d) { return d3.rgb(color(d.key)).darker(0.5)} )
            // reduce opacity of all groups
            d3.selectAll(".myArea").style("opacity", .05)
            // expect the one that is hovered
            d3.selectAll("."+d.key).style("opacity", 1)
          }
       
        }

      

        // And when it is not hovered anymore
        var noHighlight = function(e,d){
          if(typeof d === 'string'){
          
            if( className(d).length > 2){
              
              d3.select("." + className(d)).attr("font-weight", "normal")

              d3.selectAll(".circle-" +  className(d))
                .style("fill", function(d) { return color(d.focus)} )

            }else{
              d3.select("." + className(d)).attr("font-weight", "normal")
              d3.selectAll("." + d)
              .style("fill", function(d) { return color(d.focus)} )
            }


          }else{

            //set font label to normal
            d3.selectAll(".label-"+d.key)
            .attr("font-weight", "normal")

            d3.select(".mycircle-legend"+d.key)
            .style("fill", function(d) { return color(d.key)} )
        

            d3.selectAll(".myArea").style("opacity", 1)
          }
        }
      
        /****************************************** LEGEND  *****************************************/

        // Add one dot in the legend for each name.
        var size = 6
        var xAlign = -10
        var yAlign = 40 

        svg_legend.append("text")
        .text("Publication focused on HInt:")
          .attr("class", "text-legend")
          .attr("x", xAlign)
          .attr("y", yAlign - 20) // 100 is where the first dot appears. 25 is the distance between dots
          .attr("text-anchor", "left")
          .attr("font-weight", "bold")
          .style("alignment-baseline", "middle")
      

        svg_legend.selectAll("mycircle-legend")
          .data(keys)
          .enter()
          .append("circle")
              .attr("class", function(d) { return "mycircle-legend" + d.key })
              .attr("cx", function (d,i) { return xAlign + size*1.2 + (i == 2 ? i*340:i*230)})
            // .attr("y", function(d,i){ return 30 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
              .attr("cy", yAlign + size/4) 
              .attr("r",size)
              .attr("width", size)
              .attr("height", size/2)
              .attr("rx", 5)
              .attr("ry", 5)
              .style("fill", function(d){ return color(d.key)})
              .on("mouseover", highlight)
              .on("mouseleave", noHighlight)

          // Add text in the legend for each name.
          svg_legend.selectAll("mylabels")
          .data(keys)
          .enter()
          .append("text")
            .attr("cursor","default")
            .attr("class", function(d) { return "text-legend label-" + d.key })
            .attr("x", function (d,i) { return xAlign + size*3 + (i == 2 ? i*340:i*230)})
            //.attr("y", function(d,i){ return 36 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
            .attr("y", yAlign + size/4) 
            .text(function(d){ return d.name + " (" + d.key + ")"})
            .attr("text-anchor", "left")
            .style("alignment-baseline", "middle")
            .on("mouseover", highlight)
            .on("mouseleave", noHighlight)

      } //end function update()

    </script>
  </body>
</html>