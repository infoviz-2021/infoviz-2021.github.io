<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <link rel="stylesheet" href="styles/settings.css">
    <link rel="stylesheet" href="styles/generic.css">
    <link rel="stylesheet" href="styles/objects.css">
    <link rel="stylesheet" href="styles/components.css">
    <link rel="stylesheet" href="styles.css">
    <title>Trabalho de InfoViz</title>
  </head>
  <body>
    <main>
      <section class="card country-card">
        <div class="card__header">
          <h2>Countries, institutions and authors who are addressing the Human-Computer Interaction (HINT)</h2>
        </div>
        <div class="card__body">
          <div class="card__body__countries">
            <div class="card__body__countries__map"></div>
            <div class="card__body__countries__details">
              <div class="card__body__countries__details__header"></div>
              <div class="card__body__countries__details__body">
                <div class="card__body__countries__details__institutions">
                  <div class="card__body__countries__details__institutions__title"></div>
                  <ul class="card__body__countries__details__institutions__list"></ul>
                </div>
                <div class="card__body__countries__details__authors">
                  <div class="card__body__countries__details__authors__title"></div>
                  <ul class="card__body__countries__details__authors__list"></ul>
                </div>
              </div>
            </div>
            <div class="card__body__countries__tooltip"></div>
            <div class="card__body__countries__legends">
              <div class="card__body__countries__legends__legend">
                <div class="card__body__countries__legends__legend__sign">
                  <span class="card__body__countries__legends__legend__sign--light-purple"></span>
                </div>
                <div class="card__body__countries__legends__legend__description">
                  Country with at least one author and institution exploring the HInt
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      const width = '500'
      const height = '300'

      const svg = d3.select('.card__body__countries__map')
        .append('svg')
        .attr("viewBox", `0 0 ${width} ${height}`)
      
      const projection = d3
        .geoNaturalEarth1()
        .scale(width / 1.6 / Math.PI)
        .translate([width / 2, height / 2])
      
      const geoPath = d3.geoPath()
        .projection(projection)
      
      d3.json('https://raw.githubusercontent.com/infoviz-2021/infoviz-2021.github.io/main/data/countries.json').then(function (data) {
        svg.append('g')
          .selectAll('path')
          .data(data.features)
          .join('path')
          .attr('d', geoPath)
          .attr('class', function (svgElement) {
            if (svgElement.properties.articles > 0)
              return 'country country-highlighted'
            else 
              return 'country'
          })
          .on('mouseover', function (svgElement, data, key) {
            if (data.properties.articles > 0) {
              d3.select(this).attr('class', 'country hover')
              d3.select('.card__body__countries__tooltip')
                .style('visibility','visible')
                .style('top', svgElement.pageY + 10 + 'px')
                .style('left', svgElement.pageX + 10 + 'px')
                .html(`
                  <div class="country-title">
                    ${(data.properties.articles > 0) ? `<span class="flag ${data.id}-flag"></span>` : ``}
                    <span class="country-title__name"><strong>${data.properties.name}</strong></span>
                  </div>
                  <div class="country-academic-info">
                    <span>Total of institutions: ${(data.properties.institutions ? data.properties.institutions.length : 0)}</span>
                    <span>Total of authors: ${(data.properties.authors ? data.properties.authors.length : 0)}</span>
                  </div>
                `)
            }
          })
          .on('mouseout', function (d) {
            d3.select(this).attr('class', function (svgElement) {
              if (svgElement.properties.articles > 0)
                return 'country country-highlighted'
              else 
                return 'country'
            })
            d3.select('.card__body__countries__tooltip')
              .style('visibility','hidden')
          })
          .on('click', function(svgElement, data) {
            if (data.properties.articles > 0) {
              d3.select('.card__body__countries__details__header')
                .html(`
                  <span class="card__body__countries__details__header__flag ${data.id}-flag"></span>
                  <span class="card__body__countries__details__header__title">
                    <strong>Country:</strong> ${data.properties.name} (${data.id}) - Publication's total: ${data.properties.articles} of 20
                  </span>
                `)
              d3.select('.card__body__countries__details__institutions__title')
                .html(`
                  <span><strong>Institutions - Total: ${data.properties.institutions.length}</strong> of 66</span>
                `)
              d3.select('.card__body__countries__details__institutions__list')
                .selectAll('li')
                .data(data.properties.institutions)
                .join('li')
                .text(institution => institution)
              d3.select('.card__body__countries__details__authors__title')
                .html(`
                  <span><strong>Authors - Total: ${data.properties.authors.length}</strong> of 98</span>
                `)
              d3.select('.card__body__countries__details__authors__list')
                .selectAll('li')
                .data(data.properties.authors)
                .join('li')
                .text(author => author)
            }
          })
      })

      const institutionMoreButton = document.querySelector('.card__body__countries__details__institutions__button')
      institutionMoreButton.addEventListener('click', () => {
        const institutionsList = document.querySelector('.card__body__countries__details__institutions__list')
        institutionsList.classList.toggle('card__body__countries__details__institutions__list--open')
      })

      const authorsMoreButton = document.querySelector('.card__body__countries__details__authors__button')
      authorsMoreButton.addEventListener('click', () => {
        const authorsList = document.querySelector('.card__body__countries__details__authors__list')
        authorsList.classList.toggle('card__body__countries__details__authors__list--open')
      })
    </script>
  </body>
</html>
