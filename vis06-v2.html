<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-color.v1.min.js"></script>
    <script src= "https://d3js.org/d3-interpolate.v1.min.js"> </script>
    <script src= "https://d3js.org/d3-scale-chromatic.v1.min.js"> </script>
    <link href="https://allfont.net/allfont.css?fonts=roboto-medium" rel="stylesheet" type="text/css" />
    <title>Trabalho de InfoViz - Visualização 6</title>
    <style>

      .links line {
        stroke: #aaa;
      }

      .nodes circle {
        pointer-events: all;
        stroke: "black";
        stroke-width: 1.5px;
      }
      .normal-text{
          font-size: 14px;
          font-family: sans-serif;
          color: #333333;
        }

      .text-title{
        font-size: 18px;
        font-family: sans-serif;
        color: #333333;
      }

    </style>
  </head>
  <body>
    <h2 class="text-title">Authors' relationship network </h2>
    <svg width="1100" height="680"></svg>
    <script>

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

        width -= 200;

    /*var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function(d) { return d.id; }))
        .force("charge", d3.forceManyBody())
        .force("center", d3.forceCenter(width / 2, height / 2));*/

    const radius = 4;
    //const color = d3.scaleOrdinal(d3.schemeSet2);
   // bgcolor = d3.rgb(d3.schemeSet2[5])
      
      bgcolor = d3.rgb("#f6cb55"),
      //fill = [bgcolor.brighter(2),bgcolor,bgcolor.darker(1),bgcolor.darker(2)];
      fill = [bgcolor.brighter(0.5), bgcolor,bgcolor.darker(1),bgcolor.darker(1.5)];

     
    //cor de destaque: #6443ea

      // Color scale: give me a focus, I return a color
      const color = d3.scaleOrdinal()
          .domain([1,2,3,6])
          .range(fill);
          //.range(d3.schemeSet2);

    // colorPaper = d3.rgb(d3.schemeSet2[6])
    var size = 15;

    //Focus
    var keys = [
        { "key": "GR", "name":"General / All-purpose"},
        { "key": "GE", "name":"General with an emphasis on some attribute " },
        { "key": "ES", "name":"Specific"}
      ]; 

    // Color scale: give me a focus, I return a color
    const colorPaper = d3.scaleOrdinal()
          .domain(keys.map(function(d){return d.key}))
          .range(d3.schemeSet2);

    d3.json("data/network.json", function(error, data) {
      if (error) throw error;
      
      const nodes = data.nodes.map(d => Object.create(d))
      const links = data.links.map(d => Object.create(d))

      const nodes_paper = nodes.filter(d => d.type =="paper")
      const nodes_author = nodes.filter(d => d.type =="author")

      const links_paper = links.filter(d => d.source.length < 5)
      const links_author = links.filter(d => d.source.length > 4)

      const linkedByIndex = [];

      links.forEach(function(d) {
        linkedByIndex[`${d.source},${d.target}`] = 1;
      });

      
      /*const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).strength(0.2).distance(80))
        .force("charge", d3.forceManyBody().strength(function(d){return -100 }))
        .force("center", d3.forceCenter(width/2, height/2))
        .force("x", d3.forceX())
        .force("y", d3.forceY())
        .force('collision', d3.forceCollide().radius(function(d) {
          return radius * (d.qt+2);
        }));*/

      /*var simulation = d3.forceSimulation()
        .force("charge", d3.forceManyBody().strength(-120))
        .force("link", d3.forceLink().id(d => d.id).strength(0.2).distance(80))
        .force("x", d3.forceX())
        .force("y", d3.forceY())
        .force("center", d3.forceCenter((width/2), (height / 2)))
        .force('collision', d3.forceCollide().radius(function(d) {
          return radius * (d.qt+2);
        }));*/

        var simulation = d3.forceSimulation()
        .force("charge", d3.forceManyBody().strength(-100))
        .force("link", d3.forceLink().id(d => d.id).strength(0.2).distance(50))
        .force("x", d3.forceX())
        .force("y", d3.forceY())
        .force("center", d3.forceCenter((width/2), (height / 2)))
        .force('collision', d3.forceCollide().radius(function(d) {
          if(d.type === "author")
            return radius * (d.qt+2);
          return 20;
        }));

      var link = svg.append("g")
          .attr("class", "links")
        .selectAll("line")
        .data(links)
        .enter().append("line")
        .style("stroke", function(d){ 
          if(d.source.length < 5){
            //get souce node focus properties
            const getnode = nodes_paper.filter(e => e.id === d.source)
            return colorPaper(getnode[0].focus);
          }
          return "#aaa";
        })
        .attr("stroke-opacity", function(d){ 
          if(d.source.length < 5)
            return 0.5;
          return 0.3;
        })
        .attr("stroke-width", function(d){ 
          if(d.source.length < 5)
            return 2;
          return 1;
        }) ;
        //.attr("stroke-width", d => Math.sqrt(d.qt) / 2); ;

    var link_paper = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(links_paper)
        .enter().append("line")
        .style("stroke", "#aaa")
        .attr("stroke-opacity", 0.3)
      

      var node = svg.append("g")
          .attr("class", "nodes")
          //.attr("stroke", "#555")
          .selectAll("circle")
          .data(nodes_author)
          .enter()
          .append("circle")
            .attr("r", function(d){ return radius * d.qt})
            .attr("fill", function(d){ return d3.rgb(color(d.qt)).darker(0.5)})
            //.attr("fill", function(d){ return (color(d.qt))})
            .attr("stroke",function(d){ return d3.rgb(color(d.qt)).darker(2)})
            .style("cursor", "pointer")
            .on('mouseover.fade', fade(0.1))
            .on('mouseout.fade', fade(1))
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

      var node_paper = svg.append("g")
          .attr("class", "nodes").selectAll("rect")
          .data(nodes_paper)
          .enter()
          .append("rect")
            .attr("width", size)
            .attr("height", size)
            .attr("rx", 1)
            .attr("ry", 1)
            .style("fill",  function(d){ return d3.rgb(colorPaper(d.focus)).darker(0.5)})
            //.attr("fill", function(d){ return (color(d.qt))})
            .style("stroke",function(d){ return d3.rgb(colorPaper(d.focus)).darker(2)})
            .style("cursor", "pointer")
            .on('mouseover.fade', fade(0.1))
            .on('mouseout.fade', fade(1))
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

          
      node_paper.append("title").text(d => `${d.title}`);

      var textElems = svg.append('g')
        .selectAll('text')
        .data(nodes)
        .enter().append('text')
          .text(d => `${d.id} (${d.qt})`)
          .attr('font-size',12)
          .attr('font-size',12)
        // .call(drag(simulation))
        .on('mouseover.fade', fade(0.1))
        .on('mouseout.fade', fade(1))
        .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

      simulation
          .nodes(nodes)
          .on("tick", ticked);

      simulation.force("link")
          .links(links_author);
      
      simulation.force("link")
          .links(links_paper);

      function ticked() {
        link
            .attr("x1", function(d) {return d.source.x; })
            .attr("y1", function(d) {return d.source.y;})
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node
            .attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });

        node_paper
          .attr("x", function(d) { return ( d.x - size/2); })
          .attr("y", function(d) { return ( d.y - size/2); });
        
        textElems
          .attr("x", d => d.x + 10)
          .attr("y", d => d.y -10)
          .attr("visibility", "hidden");
      }


      function fade(opacity) {

        return d => {   
          node.style('opacity', function (o) { return isConnected(d, o) ? 1 : opacity });
          node_paper.style('opacity', function (o) { return isConnected(d, o) ? 1 : opacity });
        // textElems.style('visibility', function (o) { return isConnected(d, o) ? "visible" : "hidden" }); 
          textElems.style('visibility', function (o) { return d == o ? "visible" : "hidden" }); //return isConnected(d, o) ? "visible" : "hidden" }
          link.style('stroke-opacity', o => (o.source === d || o.target === d ? 1 : opacity));

          if(opacity === 1){
            node.style('opacity', 1)
            node_paper.style('opacity', 1)
            textElems.style('visibility', 'hidden')
            link.style('stroke-opacity', 0.3)
      
          }
        };
        }

        function isConnected(a, b) {
          return linkedByIndex[`${a.id},${b.id}`] || linkedByIndex[`${b.id},${a.id}`] || a.id === b.id;
        }

        function dragstarted(d) {
      if (!d3.event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(d) {
      d.fx = d3.event.x;
      d.fy = d3.event.y;
    }

    function dragended(d) {
      if (!d3.event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }


    });


      /*******
       LEGEND 
      ********/

      // Add one dot in the legend for each name.
      var size = 20
      var xAlign = 800

    /* svg.append("text")
      .text("Number of Publication")
        .attr("x", xAlign)
        .attr("y", 50) // 100 is where the first dot appears. 25 is the distance between dots
        .attr("text-anchor", "left")
        .attr("font-size", "14px")
        .attr("font-family", "sans-serif")
        .attr("font-weight", "bold")
        .style("alignment-baseline", "middle")
        .style("fill", "#444444")*/
      

      svg.selectAll("myrect")
      .data([1,2,3,6])
      .enter()
      .append("circle")
          .attr("cx", xAlign)
          .attr("cy", function(d,i){ return 30 + i*(size + (radius/2 * d))}) // 100 is where the first dot appears. 25 is the distance between dots
          .attr("r", d => radius * d)
          .style("fill", function(d){ return d3.rgb(color(d)).darker(0.5)})
          .attr("stroke",function(d){ return d3.rgb(color(d)).darker(2)})
        // .on("mouseover", highlight)
        //  .on("mouseleave", noHighlight)

      // Add one dot in the legend for each name.
      svg.selectAll("mylabels")
      .data([1,2,3,6])
      .enter()
      .append("text")
          .attr("x", xAlign + size*1.5)
          .attr("y", function(d,i){ return 35 + i*(size + (radius/2 * d))}) // 100 is where the first dot appears. 25 is the distance between dots
          .style("fill", "#343a40")
          .text(function(d){ 
            if(d == 1)
              return ("Author with 0" + d + " publication")
            return ("Author with 0" + d + " publications")
          })
          .attr("class", function(d) { return "normal-text label-" + d })
          .attr("text-anchor", "left")
          .style("alignment-baseline", "middle")
          .attr("font-size", "10px")
        // .on("mouseover", highlight)
        //  .on("mouseleave", noHighlight)


    /*************************************************************************************
     HIGHLIGHT GROUP
    *************************************************************************************/

        // What to do when one group is hovered
        var highlight = function(e,d){
          //set font label to bold
          d3.selectAll(".label-"+d)
          .attr("font-weight", "bold")

          // reduce opacity of all groups
          d3.selectAll(".myArea").style("opacity", .05)
          // expect the one that is hovered
          d3.selectAll("."+d).style("opacity", 1)
        }

        // And when it is not hovered anymore
        var noHighlight = function(e,d){

          //set font label to normal
          d3.selectAll(".label-"+d)
          .attr("font-weight", "normal")

          d3.selectAll(".myArea").style("opacity", 1)
        }

    </script>
  </body>
</html>